---
concurrency:
  cancel-in-progress: true
  group: deltahdl-${{ inputs.branch }}
jobs:
  assert-coverage:
    needs: e2e-test-coverage
    permissions:
      id-token: write
      pages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage-shard-0
          path: build/
      - name: Download unit profraw shard 0
        uses: actions/download-artifact@v4
        with:
          name: profraw-unit-shard-0
          path: profraw/unit/
      - name: Download unit profraw shard 1
        uses: actions/download-artifact@v4
        with:
          name: profraw-unit-shard-1
          path: profraw/unit/
      - name: Download unit profraw shard 2
        uses: actions/download-artifact@v4
        with:
          name: profraw-unit-shard-2
          path: profraw/unit/
      - name: Download unit profraw shard 3
        uses: actions/download-artifact@v4
        with:
          name: profraw-unit-shard-3
          path: profraw/unit/
      - name: Download e2e profraw
        uses: actions/download-artifact@v4
        with:
          name: profraw-e2e
          path: profraw/e2e/
      - name: Download integration profraw
        uses: actions/download-artifact@v4
        with:
          name: profraw-integration
          path: profraw/integration/
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18
      - name: Generate coverage report
        run: |
          llvm-profdata-18 merge -sparse \
            profraw/unit/*.profraw \
            profraw/e2e/*.profraw \
            profraw/integration/*.profraw \
            -o merged.profdata
          llvm-cov-18 show build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --format=html \
            -output-dir=coverage-html
      # DO NOT lower this threshold. Uncovered code is untested code —
      # lowering it hides bugs and lets regressions slip through silently.
      - name: Enforce 100% coverage
        run: |
          llvm-cov-18 report build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/'
          llvm-cov-18 export build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --summary-only \
            | jq -e '.data[0].totals |
              .lines.covered == .lines.count and
              .branches.covered == .branches.count' \
            || { echo "FAIL: coverage must be 100%"; exit 1; }
      - if: >-
          inputs.branch == 'main'
          && inputs.event == 'push'
        name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage-html/
      # DO NOT add continue-on-error here. If Pages deployment fails,
      # the repo settings need to be fixed (Settings > Pages > Source =
      # "GitHub Actions"), not the workflow.
      - if: >-
          inputs.branch == 'main'
          && inputs.event == 'push'
        name: Publish to GitHub Pages
        uses: actions/deploy-pages@v4
  build-asan-ubsan:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    name: build-asan-ubsan-shard-${{ matrix.shard }}
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache clang-18
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-asan-ubsan-shard-${{
            matrix.shard }}-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-asan-ubsan-shard-${{
              matrix.shard }}-
            ccache-build-asan-ubsan-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_SANITIZERS=ON
          cmake --build build --parallel 4 --target deltahdl
          targets=$(grep -oP 'add_unit_test\(\K[^)]+' \
            test/CMakeLists.txt \
            | awk "(NR-1) % 4 == ${{ matrix.shard }}")
          cmake --build build --parallel 4 --target $targets
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-asan-ubsan-shard-${{ matrix.shard }}
          path: build/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  build-coverage:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    name: build-coverage-shard-${{ matrix.shard }}
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache clang-18
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-coverage-shard-${{
            matrix.shard }}-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-coverage-shard-${{
              matrix.shard }}-
            ccache-build-coverage-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_COVERAGE=ON
          cmake --build build --parallel 4 --target deltahdl
          targets=$(grep -oP 'add_unit_test\(\K[^)]+' \
            test/CMakeLists.txt \
            | awk "(NR-1) % 4 == ${{ matrix.shard }}")
          cmake --build build --parallel 4 --target $targets
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-coverage-shard-${{ matrix.shard }}
          path: build/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  build-macos-26-arm64-clang:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: brew install ccache
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-macos-arm64-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-macos-arm64-${{ hashFiles('**/CMakeLists.txt') }}-
            ccache-build-macos-arm64-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel 2
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
          retention-days: 1
  build-tsan:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    name: build-tsan-shard-${{ matrix.shard }}
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache clang-18
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-tsan-shard-${{
            matrix.shard }}-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-tsan-shard-${{
              matrix.shard }}-
            ccache-build-tsan-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_TSAN=ON
          cmake --build build --parallel 4 --target deltahdl
          targets=$(grep -oP 'add_unit_test\(\K[^)]+' \
            test/CMakeLists.txt \
            | awk "(NR-1) % 4 == ${{ matrix.shard }}")
          cmake --build build --parallel 4 --target $targets
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-tsan-shard-${{ matrix.shard }}
          path: build/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  build-ubuntu-24-04-x86-64-clang:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    name: build-ubuntu-24-04-x86-64-clang-shard-${{ matrix.shard }}
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache clang-18
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-clang-release-shard-${{
            matrix.shard }}-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-clang-release-shard-${{
              matrix.shard }}-
            ccache-build-clang-release-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel 4 --target deltahdl
          targets=$(grep -oP 'add_unit_test\(\K[^)]+' \
            test/CMakeLists.txt \
            | awk "(NR-1) % 3 == ${{ matrix.shard }}")
          cmake --build build --parallel 4 --target $targets
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-${{ matrix.shard }}
          path: build/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2]
  build-ubuntu-24-04-x86-64-gcc:
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
    name: build-ubuntu-24-04-x86-64-gcc-shard-${{ matrix.shard }}
    needs: [clang-tidy-src, clang-tidy-test]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache g++-14
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          key: >-
            ccache-build-gcc-release-shard-${{
            matrix.shard }}-${{
            hashFiles('**/CMakeLists.txt') }}-${{
            inputs.sha }}
          path: .ccache
          restore-keys: |
            ccache-build-gcc-release-shard-${{
              matrix.shard }}-
            ccache-build-gcc-release-
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel 4 --target deltahdl
          targets=$(grep -oP 'add_unit_test\(\K[^)]+' \
            test/CMakeLists.txt \
            | awk "(NR-1) % 4 == ${{ matrix.shard }}")
          cmake --build build --parallel 4 --target $targets
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-${{ matrix.shard }}
          path: build/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  # Ensures sv-tests is cached for integration-test jobs. Compares
  # the latest remote SHA against the SV_TESTS_SHA repo variable to
  # decide if a clone is needed. On warm cache (same SHA) this is a
  # fast no-op — no files are downloaded. On cold cache (new SHA,
  # ~daily) it clones once, saves to cache, and updates the variable.
  cache-sv-tests:
    needs:
      - unit-test-coverage
      - unit-test-macos-26-arm64-clang
      - unit-test-asan-ubsan
      - unit-test-tsan
      - unit-test-ubuntu-24-04-x86-64-clang
      - unit-test-ubuntu-24-04-x86-64-gcc
    outputs:
      sv-tests-sha: ${{ steps.sv-tests-ref.outputs.sha }}
    runs-on: ubuntu-24.04
    steps:
      - id: sv-tests-ref
        name: Get latest sv-tests commit
        run: >-
          echo "sha=$(git ls-remote
          https://github.com/chipsalliance/sv-tests.git
          HEAD | cut -f1)"
          >> "$GITHUB_OUTPUT"
      - if: >-
          steps.sv-tests-ref.outputs.sha
          != vars.SV_TESTS_SHA
        name: Clone sv-tests
        run: >-
          git clone --depth 1
          https://github.com/chipsalliance/sv-tests.git
          third_party/sv-tests
      - if: >-
          steps.sv-tests-ref.outputs.sha
          != vars.SV_TESTS_SHA
        name: Save sv-tests cache
        uses: actions/cache/save@v4
        with:
          key: sv-tests-${{ steps.sv-tests-ref.outputs.sha }}
          path: third_party/sv-tests
      - env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        if: >-
          steps.sv-tests-ref.outputs.sha
          != vars.SV_TESTS_SHA
        name: Update SV_TESTS_SHA variable
        run: >-
          gh variable set SV_TESTS_SHA
          --body "${{ steps.sv-tests-ref.outputs.sha }}"
          --repo "${{ github.repository }}"
  clang-tidy-src:
    env:
      CTCACHE_DIR: ${{ github.workspace }}/.ctcache
    name: clang-tidy-src-shard-${{ matrix.shard }}
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18 clang-tidy-18
          pip install git+https://github.com/matus-chochlik/ctcache.git
      - name: Create clang-tidy wrapper
        run: |
          sudo tee /usr/local/bin/clang-tidy-cached << 'WRAPPER'
          #!/bin/bash
          exec clang-tidy-cache /usr/bin/clang-tidy-18 "${@}"
          WRAPPER
          sudo chmod +x /usr/local/bin/clang-tidy-cached
      - name: Restore ctcache
        uses: actions/cache@v4
        with:
          key: >-
            ctcache-src-${{ matrix.shard }}-${{
            hashFiles('etc/clang_tidy/src.yml') }}-${{
            inputs.sha }}
          path: .ctcache
          restore-keys: |
            ctcache-src-${{ matrix.shard }}-
      - name: Generate compile_commands.json
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Run clang-tidy (src, shard ${{ matrix.shard }}/2)
        run: |
          regex=$(jq -r '.[].file' build/compile_commands.json \
            | grep -v '/test/' \
            | grep '\.cpp$' \
            | sort \
            | awk "NR % 2 == ${{ matrix.shard }}" \
            | xargs -n1 basename \
            | sed 's/\./\\./g' \
            | sed 's|^|/|' \
            | paste -sd'|')
          run-clang-tidy-18 -p build \
            -j "$(nproc)" \
            -clang-tidy-binary /usr/local/bin/clang-tidy-cached \
            -config-file=etc/clang_tidy/src.yml \
            -extra-arg=-ferror-limit=0 \
            -extra-arg=-w \
            -warnings-as-errors='*' \
            "($regex)"
    strategy:
      fail-fast: false
      matrix:
        shard: ['00', '01']
  clang-tidy-test:
    env:
      CTCACHE_DIR: ${{ github.workspace }}/.ctcache
    name: clang-tidy-test-shard-${{ matrix.shard }}
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18 clang-tidy-18
          pip install git+https://github.com/matus-chochlik/ctcache.git
      - name: Create clang-tidy wrapper
        run: |
          sudo tee /usr/local/bin/clang-tidy-cached << 'WRAPPER'
          #!/bin/bash
          exec clang-tidy-cache /usr/bin/clang-tidy-18 "${@}"
          WRAPPER
          sudo chmod +x /usr/local/bin/clang-tidy-cached
      - name: Restore ctcache
        uses: actions/cache@v4
        with:
          key: >-
            ctcache-test-${{ matrix.shard }}-${{
            hashFiles('etc/clang_tidy/test_src_unit.yml') }}-${{
            inputs.sha }}
          path: .ctcache
          restore-keys: |
            ctcache-test-${{ matrix.shard }}-
      - name: Generate compile_commands.json
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Run clang-tidy (test, shard ${{ matrix.shard }}/18)
        run: |
          regex=$(jq -r '.[].file' build/compile_commands.json \
            | grep '/test/src/unit/.*\.cpp$' \
            | sort \
            | awk "NR % 18 == ${{ matrix.shard }}" \
            | xargs -n1 basename \
            | sed 's/\./\\./g' \
            | sed 's|^|/|' \
            | paste -sd'|')
          run-clang-tidy-18 -p build \
            -j "$(nproc)" \
            -clang-tidy-binary /usr/local/bin/clang-tidy-cached \
            -config-file=etc/clang_tidy/test_src_unit.yml \
            -extra-arg=-ferror-limit=0 \
            -extra-arg=-w \
            -warnings-as-errors='*' \
            "($regex)"
    strategy:
      fail-fast: false
      matrix:
        shard: ['00', '01', '02', '03', '04', '05',
                '06', '07', '08', '09', '10', '11',
                '12', '13', '14', '15', '16', '17']
  e2e-test-asan-ubsan:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    needs: integration-test-asan-ubsan
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-asan-ubsan-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
  e2e-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    needs: integration-test-coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-e2e
          path: profraw/
          retention-days: 1
  e2e-test-macos-26-arm64-clang:
    needs: integration-test-macos-26-arm64-clang
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
  e2e-test-tsan:
    env:
      TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1
    needs: integration-test-tsan
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-tsan-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
  e2e-test-ubuntu-24-04-x86-64-clang:
    needs: integration-test-ubuntu-24-04-x86-64-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
  e2e-test-ubuntu-24-04-x86-64-gcc:
    needs: integration-test-ubuntu-24-04-x86-64-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: PYTHONPATH=. python3 scripts/run_sim_tests.py
  # DO NOT lower the sv-tests pass threshold. Every failing test
  # represents a real LRM conformance gap — lowering it hides parser
  # and elaboration bugs instead of fixing them.
  #
  # Each integration-test job runs on a fresh runner with an empty
  # filesystem, so cache/restore is always needed to download sv-tests
  # from persistent storage — even though cache-sv-tests already saved it.
  integration-test-asan-ubsan:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-asan-ubsan-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
  integration-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-integration
          path: profraw/
          retention-days: 1
  integration-test-macos-26-arm64-clang:
    needs: cache-sv-tests
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
  integration-test-tsan:
    env:
      TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-tsan-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
  integration-test-ubuntu-24-04-x86-64-clang:
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
  integration-test-ubuntu-24-04-x86-64-gcc:
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-0
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: PYTHONPATH=. python3 scripts/run_sv_tests.py
  release:
    if: >-
      inputs.branch == 'main'
      && inputs.event == 'push'
    needs:
      - assert-coverage
      - e2e-test-macos-26-arm64-clang
      - e2e-test-asan-ubsan
      - e2e-test-tsan
      - e2e-test-ubuntu-24-04-x86-64-clang
      - e2e-test-ubuntu-24-04-x86-64-gcc
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.sha }}
      - name: Download Ubuntu build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-0
          path: ubuntu-build/
      - name: Download macOS build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: macos-build/
      - id: version
        name: Generate version from UTC time
        run: >-
          echo "version=$(date -u +%Y%m%d%H%M%S)"
          >> $GITHUB_OUTPUT
      - name: Create tag
        run: >-
          git tag
          "v${{ steps.version.outputs.version }}"
      - name: Push tag
        run: >-
          git push origin
          "v${{ steps.version.outputs.version }}"
      - env:
          GH_TOKEN: ${{ github.token }}
        name: Create GitHub Release
        run: |
          cp ubuntu-build/src/deltahdl \
            deltahdl-linux-amd64
          cp macos-build/src/deltahdl \
            deltahdl-macos-arm64
          gh release create \
            "v${{ steps.version.outputs.version }}" \
            --generate-notes \
            deltahdl-linux-amd64 \
            deltahdl-macos-arm64
      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
  static-analysis:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          key: >-
            pip-${{ github.job }}-${{
            hashFiles('.github/workflows/deltahdl.yml') }}
          path: ~/.cache/pip
          restore-keys: |
            pip-${{ github.job }}-
      - name: Restore PMD cache
        uses: actions/cache@v4
        with:
          key: pmd-7.21.0
          path: pmd-bin-7.21.0
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          if [ ! -d pmd-bin-7.21.0 ]; then
            PMD=pmd-dist-7.21.0-bin.zip
            PMD_URL=https://github.com/pmd/pmd/releases
            wget -q "$PMD_URL/download/pmd_releases%2F7.21.0/$PMD"
            unzip -q "$PMD"
          fi
          echo "$PWD/pmd-bin-7.21.0/bin" >> "$GITHUB_PATH"
      - name: Check formatting
        run: |
          find src test -name '*.cpp' -o -name '*.h' | \
            xargs clang-format-18 \
            --dry-run --Werror --style=google
      - name: Check file line limits
        run: |
          fail=0
          for f in $(find src test -name '*.cpp' -o -name '*.h')
          do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 1000 ]; then
              echo "FAIL: $f has $lines lines (max 1000)"
              fail=1
            fi
          done
          exit $fail
      - name: Detect copy-paste
        run: >-
          pmd cpd
          --minimum-tokens 100
          --language cpp
          --dir src/
      # DO NOT disable this step. Inline suppression comments (NOLINT,
      # clang-format off, etc.) hide problems instead of fixing them and
      # make the codebase progressively harder to maintain.
      - name: Assert no inline directives
        run: |
          pip install assert-no-inline-directives
          assert-no-inline-directives \
            --tools clang-tidy,clang-format,clang-diagnostic \
            src/ test/
  unit-test-asan-ubsan:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    name: unit-test-asan-ubsan-shard-${{ matrix.shard }}
    needs: build-asan-ubsan
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-asan-ubsan-shard-${{ matrix.shard }}
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          --label-exclude e2e
          --exclude-regex '_NOT_BUILT'
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  unit-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    name: unit-test-coverage-shard-${{ matrix.shard }}
    needs: build-coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage-shard-${{ matrix.shard }}
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          --label-exclude e2e
          --exclude-regex '_NOT_BUILT'
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-unit-shard-${{ matrix.shard }}
          path: profraw/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  unit-test-macos-26-arm64-clang:
    needs: build-macos-26-arm64-clang
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
  unit-test-tsan:
    env:
      TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1
    name: unit-test-tsan-shard-${{ matrix.shard }}
    needs: build-tsan
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-tsan-shard-${{ matrix.shard }}
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          --label-exclude e2e
          --exclude-regex '_NOT_BUILT'
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
  unit-test-ubuntu-24-04-x86-64-clang:
    needs: build-ubuntu-24-04-x86-64-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build shard 0
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-0
          path: build/
      - name: Download build shard 1
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-1
          path: build/
      - name: Download build shard 2
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang-shard-2
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
  unit-test-ubuntu-24-04-x86-64-gcc:
    needs: build-ubuntu-24-04-x86-64-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
      - name: Download build shard 0
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-0
          path: build/
      - name: Download build shard 1
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-1
          path: build/
      - name: Download build shard 2
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-2
          path: build/
      - name: Download build shard 3
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc-shard-3
          path: build/
      - name: Fix permissions
        run: >-
          find build/test -maxdepth 1 -type f -name 'test_*'
          -exec chmod +x {} +
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
name: DeltaHDL
on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch that triggered CI
        required: true
        type: string
      event:
        description: Event that triggered CI (push or pull_request)
        required: true
        type: string
      sha:
        description: Commit SHA to check out
        required: true
        type: string
