---
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  build-clang:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build --parallel
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-clang-${{ matrix.build_type }}
          path: build/
          retention-days: 1
    strategy:
      matrix:
        build_type: [Debug, Release]
  build-gcc:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build --parallel
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-gcc-${{ matrix.build_type }}
          path: build/
          retention-days: 1
    strategy:
      matrix:
        build_type: [Debug, Release]
  build-macos:
    needs: static-analysis
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build --parallel
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-${{ matrix.build_type }}
          path: build/
          retention-days: 1
    strategy:
      matrix:
        build_type: [Debug, Release]
  coverage-linux:
    needs: [integration-test-clang, integration-test-gcc]
    permissions:
      id-token: write
      pages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18 llvm-18
      - name: Build with coverage
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_COVERAGE=ON
          cmake --build build --parallel
      - env:
          LLVM_PROFILE_FILE: build/coverage/%p.profraw
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
      - name: Generate coverage report
        run: |
          llvm-profdata-18 merge -sparse \
            build/coverage/*.profraw \
            -o build/coverage/merged.profdata
          llvm-cov-18 show build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --format=html \
            -output-dir=build/coverage/html
      - name: Enforce 100% coverage
        run: |
          llvm-cov-18 report build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/'
          llvm-cov-18 export build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --summary-only \
            | jq -e '.data[0].totals |
              .lines.covered == .lines.count and
              .branches.covered == .branches.count' \
            || { echo "FAIL: coverage must be 100%"; exit 1; }
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Upload coverage pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/coverage/html
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
  coverage-macos:
    needs: integration-test-macos
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build with coverage
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_COVERAGE=ON
          cmake --build build --parallel
      - env:
          LLVM_PROFILE_FILE: build/coverage/%p.profraw
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
      - name: Generate coverage report
        run: |
          xcrun llvm-profdata merge -sparse \
            build/coverage/*.profraw \
            -o build/coverage/merged.profdata
          xcrun llvm-cov show build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --format=html \
            -output-dir=build/coverage/html
      - name: Enforce 100% coverage
        run: |
          xcrun llvm-cov report build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/'
          xcrun llvm-cov export build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --summary-only \
            | jq -e '.data[0].totals |
              .lines.covered == .lines.count and
              .branches.covered == .branches.count' \
            || { echo "FAIL: coverage must be 100%"; exit 1; }
  e2e-test-linux:
    needs: [integration-test-clang, integration-test-gcc]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-gcc-Release
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: python3 scripts/run_sv_tests.py
  e2e-test-macos:
    needs: integration-test-macos
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-Release
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Run sv-tests
        run: python3 scripts/run_sv_tests.py
  integration-test-clang:
    needs: unit-test-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-clang-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: |
          for sv in test/integration/*.sv; do
            echo "--- Simulating $sv ---"
            ./build/src/deltahdl "$sv"
          done
    strategy:
      matrix:
        build_type: [Debug, Release]
  integration-test-gcc:
    needs: unit-test-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-gcc-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: |
          for sv in test/integration/*.sv; do
            echo "--- Simulating $sv ---"
            ./build/src/deltahdl "$sv"
          done
    strategy:
      matrix:
        build_type: [Debug, Release]
  integration-test-macos:
    needs: unit-test-macos
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: |
          for sv in test/integration/*.sv; do
            echo "--- Simulating $sv ---"
            ./build/src/deltahdl "$sv"
          done
    strategy:
      matrix:
        build_type: [Debug, Release]
  release-linux:
    if: >-
      github.ref == 'refs/heads/main'
      && github.event_name == 'push'
    needs: [sanitize-linux, sanitize-macos]
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14
      - id: version
        name: Generate version from UTC time
        run: >-
          echo "version=$(date -u +%Y%m%d%H%M%S)"
          >> $GITHUB_OUTPUT
      - name: Build release binary
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel
      - name: Create tag
        run: >-
          git tag "v${{ steps.version.outputs.version }}"
      - name: Push tag
        run: >-
          git push origin
          "v${{ steps.version.outputs.version }}"
      - env:
          GH_TOKEN: ${{ github.token }}
        name: Create GitHub Release
        run: |
          cp build/src/deltahdl deltahdl-linux-amd64
          gh release create \
            "v${{ steps.version.outputs.version }}" \
            --generate-notes \
            deltahdl-linux-amd64
      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
  release-macos:
    if: >-
      github.ref == 'refs/heads/main'
      && github.event_name == 'push'
    needs: release-linux
    permissions:
      contents: write
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build release binary
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel
      - env:
          GH_TOKEN: ${{ github.token }}
        name: Upload macOS binary
        run: |
          cp build/src/deltahdl deltahdl-macos-arm64
          TAG=$(gh release list \
            --limit 1 --json tagName \
            -q '.[0].tagName')
          gh release upload "$TAG" deltahdl-macos-arm64
  sanitize-linux:
    needs: coverage-linux
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build with sanitizers
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_SANITIZERS=ON
          cmake --build build --parallel
      - env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
  sanitize-macos:
    needs: coverage-macos
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build with sanitizers
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_SANITIZERS=ON
          cmake --build build --parallel
      - env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
  static-analysis:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-18 clang-tidy-18 clang-format-18 cppcheck
          pip install yamllint
          PMD=pmd-dist-7.21.0-bin.zip
          PMD_URL=https://github.com/pmd/pmd/releases
          wget -q "$PMD_URL/download/pmd_releases%2F7.21.0/$PMD"
          unzip -q pmd-dist-7.21.0-bin.zip
          echo "$PWD/pmd-bin-7.21.0/bin" >> "$GITHUB_PATH"
      - name: Lint YAML
        run: |
          EMPTY='empty-lines: {max: 0, max-start: 0, max-end: 1}'
          KEY='key-ordering: enable'
          NL='new-line-at-end-of-file: enable'
          TR='truthy: {allowed-values: ["true", "false", "on"]}'
          RULES="$EMPTY, $KEY, $NL, $TR"
          yamllint --strict \
            --config-data \
            "{extends: default, rules: {$RULES}}" \
            .github/workflows/*.yml
      - name: Check formatting
        run: |
          find src -name '*.cpp' -o -name '*.h' | \
            xargs clang-format-18 \
            --dry-run --Werror --style=google
      - name: Check file line limits
        run: |
          fail=0
          for f in $(find src -name '*.cpp' -o -name '*.h')
          do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 1000 ]; then
              echo "FAIL: $f has $lines lines (max 1000)"
              fail=1
            fi
          done
          exit $fail
      - name: Detect copy-paste
        run: >-
          pmd cpd
          --minimum-tokens 100
          --language cpp
          --dir src/
      - name: Configure build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Run cppcheck
        # NEVER use --suppress. Fix the code instead.
        run: |
          CATCH2=$(find build/_deps \
            -name catch2-src -type d)
          cppcheck --enable=all --std=c++23 \
            -I src -I "$CATCH2/src" \
            src/ test/ 2>&1 | tee /tmp/cppcheck.log
          SEV='(error|warning|style|performance|portability):'
          FOUND=$(grep -cE ": $SEV" /tmp/cppcheck.log \
            || true)
          if [ "$FOUND" -gt 0 ]; then
            grep -E ": $SEV" /tmp/cppcheck.log
            echo "FAIL: $FOUND cppcheck finding(s)"
            exit 1
          fi
      - name: Run clang-tidy
        run: |
          find src -name '*.cpp' | \
            xargs clang-tidy-18 -p build \
              --warnings-as-errors=\
          'readability-function-size,'\
          'readability-function-cognitive-complexity' \
              --config='{
                Checks: "-*,
                  bugprone-*,
                  -bugprone-easily-swappable-parameters,
                  cppcoreguidelines-avoid-goto,
                  cppcoreguidelines-init-variables,
                  cppcoreguidelines-slicing,
                  misc-redundant-expression,
                  misc-unused-parameters,
                  modernize-use-auto,
                  modernize-use-nullptr,
                  modernize-use-override,
                  performance-*,
                  readability-function-cognitive-complexity,
                  readability-function-size,
                  readability-identifier-naming,
                  readability-redundant-smartptr-get,
                  readability-simplify-boolean-expr",
                HeaderFilterRegex: "src/.*\\.h$",
                CheckOptions: {
                  readability-function-size.NestingThreshold:
                    3,
                  readability-function-size.ParameterThreshold:
                    5,
                  readability-function-size.StatementThreshold:
                    50,
                  readability-function-size.LineThreshold:
                    200,
                  readability-function-cognitive-complexity
                    .Threshold: 15,
                  readability-identifier-naming.ClassCase:
                    CamelCase,
                  readability-identifier-naming.FunctionCase:
                    lower_case,
                  readability-identifier-naming.VariableCase:
                    lower_case,
                  readability-identifier-naming
                    .PrivateMemberCase: lower_case,
                  readability-identifier-naming
                    .PrivateMemberSuffix: "_",
                  readability-identifier-naming
                    .PublicMemberCase: lower_case,
                  readability-identifier-naming.ConstantCase:
                    CamelCase,
                  readability-identifier-naming
                    .ConstantPrefix: k,
                  readability-identifier-naming
                    .EnumConstantCase: CamelCase,
                  readability-identifier-naming.NamespaceCase:
                    lower_case
                }
              }'
  unit-test-clang:
    needs: build-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-clang-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/test/test_*
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure
    strategy:
      matrix:
        build_type: [Debug, Release]
  unit-test-gcc:
    needs: build-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-gcc-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/test/test_*
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure
    strategy:
      matrix:
        build_type: [Debug, Release]
  unit-test-macos:
    needs: build-macos
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/test/test_*
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure
    strategy:
      matrix:
        build_type: [Debug, Release]
name: CI
on:
  pull_request:
  push:
    branches: [main]
