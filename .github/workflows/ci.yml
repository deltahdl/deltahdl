---
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  assert-coverage:
    needs: e2e-test-coverage
    permissions:
      id-token: write
      pages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage
          path: build/
      - name: Download unit profraw
        uses: actions/download-artifact@v4
        with:
          name: profraw-unit
          path: profraw/unit/
      - name: Download e2e profraw
        uses: actions/download-artifact@v4
        with:
          name: profraw-e2e
          path: profraw/e2e/
      - name: Download integration profraw
        uses: actions/download-artifact@v4
        with:
          name: profraw-integration
          path: profraw/integration/
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18
      - name: Generate coverage report
        run: |
          llvm-profdata-18 merge -sparse \
            profraw/unit/*.profraw \
            profraw/e2e/*.profraw \
            profraw/integration/*.profraw \
            -o merged.profdata
          llvm-cov-18 show build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --format=html \
            -output-dir=coverage-html
      - name: Enforce 100% coverage
        run: |
          llvm-cov-18 report build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/'
          llvm-cov-18 export build/src/deltahdl \
            -instr-profile=merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --summary-only \
            | jq -e '.data[0].totals |
              .lines.covered == .lines.count and
              .branches.covered == .branches.count' \
            || { echo "FAIL: coverage must be 100%"; exit 1; }
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage-html/
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Publish to GitHub Pages
        uses: actions/deploy-pages@v4
  build-coverage:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_COVERAGE=ON
          cmake --build build --parallel --target deltahdl
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-coverage
          path: build/
          retention-days: 1
  build-macos-26-arm64-clang:
    needs: static-analysis
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel --target deltahdl
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
          retention-days: 1
  build-sanitize:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_SANITIZERS=ON
          cmake --build build --parallel --target deltahdl
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-sanitize
          path: build/
          retention-days: 1
  build-ubuntu-24-04-x86-64-clang:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel --target deltahdl
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang
          path: build/
          retention-days: 1
  build-ubuntu-24-04-x86-64-gcc:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel --target deltahdl
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc
          path: build/
          retention-days: 1
  # Serializes sv-tests clone to a single job so that on a cold cache
  # (new sv-tests SHA, which happens ~daily) only one clone runs
  # instead of 5 parallel clones. On warm cache this is a fast no-op.
  # Integration-test jobs then restore from the persistent cache.
  cache-sv-tests:
    needs:
      - unit-test-coverage
      - unit-test-macos-26-arm64-clang
      - unit-test-sanitize
      - unit-test-ubuntu-24-04-x86-64-clang
      - unit-test-ubuntu-24-04-x86-64-gcc
    outputs:
      sv-tests-sha: ${{ steps.sv-tests-ref.outputs.sha }}
    runs-on: ubuntu-24.04
    steps:
      - id: sv-tests-ref
        name: Get latest sv-tests commit
        run: >-
          echo "sha=$(git ls-remote
          https://github.com/chipsalliance/sv-tests.git
          HEAD | cut -f1)"
          >> "$GITHUB_OUTPUT"
      - id: cache
        name: Restore sv-tests cache
        uses: actions/cache@v4
        with:
          key: sv-tests-${{ steps.sv-tests-ref.outputs.sha }}
          path: third_party/sv-tests
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Clone sv-tests
        run: >-
          git clone --depth 1
          https://github.com/chipsalliance/sv-tests.git
          third_party/sv-tests
  e2e-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    needs: integration-test-coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: python3 scripts/run_sim_tests.py
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-e2e
          path: profraw/
          retention-days: 1
  e2e-test-macos-26-arm64-clang:
    needs: integration-test-macos-26-arm64-clang
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: python3 scripts/run_sim_tests.py
  e2e-test-sanitize:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    needs: integration-test-sanitize
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-sanitize
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: python3 scripts/run_sim_tests.py
  e2e-test-ubuntu-24-04-x86-64-clang:
    needs: integration-test-ubuntu-24-04-x86-64-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: python3 scripts/run_sim_tests.py
  e2e-test-ubuntu-24-04-x86-64-gcc:
    needs: integration-test-ubuntu-24-04-x86-64-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: E2E tests
        run: python3 scripts/run_sim_tests.py
  integration-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: python3 scripts/run_sv_tests.py
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-integration
          path: profraw/
          retention-days: 1
  integration-test-macos-26-arm64-clang:
    needs: cache-sv-tests
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: python3 scripts/run_sv_tests.py
  integration-test-sanitize:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-sanitize
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: python3 scripts/run_sv_tests.py
  integration-test-ubuntu-24-04-x86-64-clang:
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: python3 scripts/run_sv_tests.py
  integration-test-ubuntu-24-04-x86-64-gcc:
    needs: cache-sv-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Restore sv-tests cache
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: sv-tests-${{ needs.cache-sv-tests.outputs.sv-tests-sha }}
          path: third_party/sv-tests
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl
      - name: Integration tests
        run: python3 scripts/run_sv_tests.py
  release:
    if: >-
      github.ref == 'refs/heads/main'
      && github.event_name == 'push'
    needs:
      - assert-coverage
      - e2e-test-macos-26-arm64-clang
      - e2e-test-sanitize
      - e2e-test-ubuntu-24-04-x86-64-clang
      - e2e-test-ubuntu-24-04-x86-64-gcc
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Ubuntu build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc
          path: ubuntu-build/
      - name: Download macOS build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: macos-build/
      - id: version
        name: Generate version from UTC time
        run: >-
          echo "version=$(date -u +%Y%m%d%H%M%S)"
          >> $GITHUB_OUTPUT
      - name: Create tag
        run: >-
          git tag
          "v${{ steps.version.outputs.version }}"
      - name: Push tag
        run: >-
          git push origin
          "v${{ steps.version.outputs.version }}"
      - env:
          GH_TOKEN: ${{ github.token }}
        name: Create GitHub Release
        run: |
          cp ubuntu-build/src/deltahdl \
            deltahdl-linux-amd64
          cp macos-build/src/deltahdl \
            deltahdl-macos-arm64
          gh release create \
            "v${{ steps.version.outputs.version }}" \
            --generate-notes \
            deltahdl-linux-amd64 \
            deltahdl-macos-arm64
      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
  static-analysis:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-18 clang-tidy-18 clang-format-18
          pip install yamllint pylint mypy
          npm install -g jscpd
          PMD=pmd-dist-7.21.0-bin.zip
          PMD_URL=https://github.com/pmd/pmd/releases
          wget -q "$PMD_URL/download/pmd_releases%2F7.21.0/$PMD"
          unzip -q pmd-dist-7.21.0-bin.zip
          echo "$PWD/pmd-bin-7.21.0/bin" >> "$GITHUB_PATH"
      - name: Lint YAML
        run: |
          EMPTY='empty-lines: {max: 0, max-start: 0, max-end: 1}'
          KEY='key-ordering: enable'
          NL='new-line-at-end-of-file: enable'
          TR='truthy: {allowed-values: ["true", "false", "on"]}'
          RULES="$EMPTY, $KEY, $NL, $TR"
          yamllint --strict \
            --config-data \
            "{extends: default, rules: {$RULES}}" \
            .github/workflows/*.yml
      - name: Check formatting
        run: |
          find src test -name '*.cpp' -o -name '*.h' | \
            xargs clang-format-18 \
            --dry-run --Werror --style=google
      - name: Check file line limits
        run: |
          fail=0
          for f in $(find src test -name '*.cpp' -o -name '*.h')
          do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 1000 ]; then
              echo "FAIL: $f has $lines lines (max 1000)"
              fail=1
            fi
          done
          exit $fail
      - name: Detect copy-paste
        run: >-
          pmd cpd
          --minimum-tokens 100
          --language cpp
          --dir src/
      - name: Generate compile_commands.json
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Run clang-tidy
        run: >-
          find src -name '*.cpp' |
          xargs clang-tidy-18 -p build
          --config-file=.clang-tidy
          --warnings-as-errors='*'
      - name: Run pylint
        run: >-
          python3 -m pylint scripts/
          --fail-on=C,R,W --fail-under=10.0
      - name: Run mypy
        run: python3 -m mypy scripts/
      - name: Detect Python copy-paste
        run: >-
          jscpd --pattern "**/*.py" --threshold 0
          --reporters console scripts/
  unit-test-coverage:
    env:
      LLVM_PROFILE_FILE: ${{ github.workspace }}/profraw/%p.profraw
    needs: build-coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-coverage
          path: build/
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build tests
        run: cmake --build build --parallel
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
      - name: Upload profraw
        uses: actions/upload-artifact@v4
        with:
          name: profraw-unit
          path: profraw/
          retention-days: 1
  unit-test-macos-26-arm64-clang:
    needs: build-macos-26-arm64-clang
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-macos-26-arm64-clang
          path: build/
      - name: Build tests
        run: cmake --build build --parallel
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
  unit-test-sanitize:
    env:
      ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
      UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
    needs: build-sanitize
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-sanitize
          path: build/
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build tests
        run: cmake --build build --parallel
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
  unit-test-ubuntu-24-04-x86-64-clang:
    needs: build-ubuntu-24-04-x86-64-clang
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-clang
          path: build/
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build tests
        run: cmake --build build --parallel
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
  unit-test-ubuntu-24-04-x86-64-gcc:
    needs: build-ubuntu-24-04-x86-64-gcc
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-24-04-x86-64-gcc
          path: build/
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14
      - name: Build tests
        run: cmake --build build --parallel
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure --label-exclude e2e
name: CI
on:
  pull_request:
    paths-ignore: ["docs/**", "*.md", LICENSE]
  push:
    branches: [main]
    paths-ignore: ["docs/**", "*.md", LICENSE]
