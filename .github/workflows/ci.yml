---
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  build:
    needs: static-analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install compiler
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" = "gcc-14" ]; then
            sudo apt-get install -y g++-14
            echo "CXX=g++-14" >> "$GITHUB_ENV"
            echo "CC=gcc-14" >> "$GITHUB_ENV"
          else
            sudo apt-get install -y clang-18
            echo "CXX=clang++-18" >> "$GITHUB_ENV"
            echo "CC=clang-18" >> "$GITHUB_ENV"
          fi
      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
            -DCMAKE_C_COMPILER=${{ env.CC }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build --parallel
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: build/
          retention-days: 1
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc-14, clang-18]
  coverage:
    needs: test
    permissions:
      id-token: write
      pages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18 llvm-18
      - name: Build with coverage
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_COVERAGE=ON
          cmake --build build --parallel
      - env:
          LLVM_PROFILE_FILE: build/coverage/%p.profraw
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
      - name: Generate coverage report
        run: |
          llvm-profdata-18 merge -sparse \
            build/coverage/*.profraw \
            -o build/coverage/merged.profdata
          llvm-cov-18 show build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --format=html \
            -output-dir=build/coverage/html
      - name: Enforce 100% coverage
        run: |
          llvm-cov-18 report build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/'
          llvm-cov-18 export build/src/deltahdl \
            -instr-profile=build/coverage/merged.profdata \
            --ignore-filename-regex='test/|third_party/' \
            --summary-only \
            | jq -e '.data[0].totals |
              .lines.covered == .lines.count and
              .branches.covered == .branches.count' \
            || { echo "FAIL: line and branch coverage must be 100%"; exit 1; }
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Upload coverage pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/coverage/html
      - if: >-
          github.ref == 'refs/heads/main'
          && github.event_name == 'push'
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
  release:
    if: >-
      github.ref == 'refs/heads/main'
      && github.event_name == 'push'
    needs: sanitize
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Install compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14
      - id: version
        name: Generate version from UTC time
        run: >-
          echo "version=$(date -u +%Y%m%d%H%M%S)"
          >> $GITHUB_OUTPUT
      - name: Build release binary
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel
      - name: Create tag
        run: >-
          git tag "v${{ steps.version.outputs.version }}"
      - name: Push tag
        run: >-
          git push origin
          "v${{ steps.version.outputs.version }}"
      - env:
          GH_TOKEN: ${{ github.token }}
        name: Create GitHub Release
        run: |
          gh release create \
            "v${{ steps.version.outputs.version }}" \
            --generate-notes \
            build/src/deltahdl
      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
  sanitize:
    needs: coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18
      - name: Build with sanitizers
        run: |
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDELTAHDL_SANITIZERS=ON
          cmake --build build --parallel
      - env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        name: Run tests
        run: |
          ctest --test-dir build --output-on-failure
          for sv in test/integration/*.sv; do
            ./build/src/deltahdl "$sv"
          done
  static-analysis:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-18 clang-tidy-18 clang-format-18 cppcheck
          pip install yamllint
          PMD=pmd-dist-7.21.0-bin.zip
          PMD_URL=https://github.com/pmd/pmd/releases
          wget -q "$PMD_URL/download/pmd_releases%2F7.21.0/$PMD"
          unzip -q pmd-dist-7.21.0-bin.zip
          echo "$PWD/pmd-bin-7.21.0/bin" >> "$GITHUB_PATH"
      - name: Lint YAML
        run: |
          EMPTY_LINES='empty-lines: {max: 0, max-start: 0, max-end: 1}'
          KEY_ORDERING='key-ordering: enable'
          NEWLINE_AT_EOF='new-line-at-end-of-file: enable'
          TRUTHY='truthy: {allowed-values: ["true", "false", "on"]}'
          RULES="$EMPTY_LINES, $KEY_ORDERING"
          RULES="$RULES, $NEWLINE_AT_EOF, $TRUTHY"
          yamllint --strict \
            --config-data "{extends: default, rules: {$RULES}}" \
            .github/workflows/*.yml
      - name: Check formatting
        run: |
          find src -name '*.cpp' -o -name '*.h' | \
            xargs clang-format-18 --dry-run --Werror --style=google
      - name: Check file line limits
        run: |
          fail=0
          for f in $(find src -name '*.cpp' -o -name '*.h'); do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 1000 ]; then
              echo "FAIL: $f has $lines lines (max 1000)"
              fail=1
            fi
          done
          exit $fail
      - name: Detect copy-paste
        run: |
          pmd cpd --minimum-tokens 100 --language cpp --dir src/
      - name: Run cppcheck
        run: |
          cppcheck --error-exitcode=1 \
            --enable=warning,style,performance,portability,unusedFunction \
            --std=c++23 -I src src/ test/
      - name: Run clang-tidy
        run: |
          cmake -B build -DCMAKE_CXX_COMPILER=clang++-18 \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          find src -name '*.cpp' | \
            xargs clang-tidy-18 -p build \
              --warnings-as-errors=\
          'readability-function-size,'\
          'readability-function-cognitive-complexity' \
              --config='{
                Checks: "-*,
                  bugprone-*,
                  -bugprone-easily-swappable-parameters,
                  cppcoreguidelines-avoid-goto,
                  cppcoreguidelines-init-variables,
                  cppcoreguidelines-slicing,
                  misc-redundant-expression,
                  misc-unused-parameters,
                  modernize-use-auto,
                  modernize-use-nullptr,
                  modernize-use-override,
                  performance-*,
                  readability-function-cognitive-complexity,
                  readability-function-size,
                  readability-identifier-naming,
                  readability-redundant-smartptr-get,
                  readability-simplify-boolean-expr",
                HeaderFilterRegex: "src/.*\\.h$",
                CheckOptions: {
                  readability-function-size.NestingThreshold: 3,
                  readability-function-size.ParameterThreshold: 5,
                  readability-function-size.StatementThreshold: 50,
                  readability-function-size.LineThreshold: 200,
                  readability-function-cognitive-complexity.Threshold:
                    15,
                  readability-identifier-naming.ClassCase: CamelCase,
                  readability-identifier-naming.FunctionCase:
                    lower_case,
                  readability-identifier-naming.VariableCase:
                    lower_case,
                  readability-identifier-naming.PrivateMemberCase:
                    lower_case,
                  readability-identifier-naming.PrivateMemberSuffix:
                    "_",
                  readability-identifier-naming.PublicMemberCase:
                    lower_case,
                  readability-identifier-naming.ConstantCase:
                    CamelCase,
                  readability-identifier-naming.ConstantPrefix: k,
                  readability-identifier-naming.EnumConstantCase:
                    CamelCase,
                  readability-identifier-naming.NamespaceCase:
                    lower_case
                }
              }'
  test:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: build/
      - name: Fix permissions
        run: chmod +x build/src/deltahdl build/test/test_*
      - name: Unit tests
        run: ctest --test-dir build --output-on-failure
      - name: Integration tests
        run: |
          for sv in test/integration/*.sv; do
            echo "--- Simulating $sv ---"
            ./build/src/deltahdl "$sv"
          done
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc-14, clang-18]
name: CI
on:
  pull_request:
  push:
    branches: [main]
